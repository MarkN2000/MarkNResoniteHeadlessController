# MarkN Resonite Headless Controller 開発計画

## プロジェクト概要

Resoniteのヘッドレスサーバーを、ローカルネットワーク内のPCやスマートフォンのブラウザから簡単に操作・管理するためのWebアプリケーションの開発計画です。

## アーキテクチャ概要

```
ブラウザ (Svelte + Skeleton UI)
   ↕ HTTP / WebSocket (JWT + APIキー)
バックエンド (Node.js / Express + Socket.io)
   ↕ 標準入出力 / Configファイル
Resonite ヘッドレスサーバー
```

- **バックエンド** はヘッドレスプロセスを管理し、ログ取得・コマンド送信・REST API を提供
- **フロントエンド** はリアルタイムUIを提供し、WebSocketでログやステータスを購読
- **セキュリティ** は JWT と APIキー（共通シークレット派生）、CIDR制限で保護

## 技術スタック

- **バックエンド**: Node.js
- **フロントエンド**: Svelte
- **認証**: JWT (JSON Web Token)
- **通信**: WebSocket (Socket.io) + REST API
- **外部連携**: REST API（APIキー対応）
- **UIライブラリ**: Tailwind CSS + Skeleton UI + カスタムコンポーネント
- **ブランドカラー**: Resonite公式カラーをTailwindテーマとして採用 ([Resonite Branding](https://wiki.resonite.com/Branding))

## プロジェクト構造

```
MarkNResoniteHeadlessController/
├── agent/                  # AI協業用ドキュメント
├── backend/                # Node.js バックエンド
│   ├── src/
│   │   ├── app.ts
│   │   ├── config/
│   │   ├── http/
│   │   ├── ws/
│   │   ├── services/
│   │   └── utils/
│   ├── tests/
│   └── package.json
├── config/
│   ├── headless/           # Resonite 用 config.json
│   └── security.json       # CIDR等セキュリティ設定
├── docs/
├── frontend/
│   ├── src/
│   │   ├── App.svelte
│   │   ├── components/
│   │   ├── routes/
│   │   └── stores/
│   ├── static/
│   └── package.json
├── scripts/
├── shared/                 # 共通型・ユーティリティ
├── .env.example
├── package.json            # npm workspaces
└── README.md
```

## セキュリティ方針

- `.env` に `AUTH_SHARED_SECRET` を定義し、JWTサイン・初期パスワード・APIキー（`sha256(secret + "api")`）に活用
- すべてのREST/WebSocketリクエストはJWT必須、APIキーは外部連携時に併用
- `config/security.json` のCIDR（初期: `192.168.0.0/16`, `10.0.0.0/8`）でアクセス元IPを制限
- 機密情報はリポジトリに含めず、環境変数とSecret Managerで管理

## 開発フェーズ

### フェーズ1: 最小構成 (MVP)
**目標**: 基本的なサーバー操作とログ表示機能

**主要機能**:
- サーバーの起動・停止機能
- 生ログのリアルタイム表示
- 基本的なWebSocket通信
- シンプルなWeb UI

**成果物**:
- 動作する最小限のWebアプリケーション
- サーバープロセス管理機能
- リアルタイムログ表示

### フェーズ2: 基本機能
**目標**: 設定管理と認証、基本情報表示

**主要機能**:
- 設定ファイルのGUI編集機能
- JWT認証システム
- `/status`と`/users`コマンドによる情報表示
- PCリソース監視機能
- セッション管理機能

**成果物**:
- 認証付きWebアプリケーション
- 設定管理システム
- サーバー状態監視機能

### フェーズ3: 応用機能
**目標**: ユーザー管理とワールド操作機能

**主要機能**:
- ユーザーリストからの個別操作
- ワールド管理機能（保存、閉じる）
- フレンド管理機能
- チャット送信機能
- 条件付き自動再起動機能

**成果物**:
- 完全なユーザー管理システム
- ワールド操作機能
- フレンド管理システム

### フェーズ4: 外部連携
**目標**: API提供とUI/UX改善

**主要機能**:
- 外部連携用REST API
- Resonite Modとの連携機能
- UI/UXの全体的な改善
- パフォーマンス最適化

**成果物**:
- 外部連携API
- 最適化されたUI
- 完全なドキュメント

## マイルストーン

### マイルストーン1: MVP完成 (フェーズ1完了)
- [ ] 基本的なサーバー操作機能
- [ ] リアルタイムログ表示
- [ ] 最小限のWeb UI

### マイルストーン2: 基本機能完成 (フェーズ2完了)
- [ ] JWT認証システム
- [ ] 設定管理機能
- [ ] サーバー状態監視

### マイルストーン3: 応用機能完成 (フェーズ3完了)
- [ ] ユーザー管理機能
- [ ] ワールド操作機能
- [ ] フレンド管理機能

### マイルストーン4: 完全版完成 (フェーズ4完了)
- [ ] 外部連携API
- [ ] UI/UX最適化
- [ ] 完全なドキュメント

## 開発方針

### 1. 段階的開発
- 各フェーズで動作するバージョンを提供
- 早期フィードバックの収集
- リスクの早期発見と対応

### 2. 品質重視
- 各機能の単体テスト
- 統合テストの実施
- セキュリティ要件の遵守

### 3. ドキュメント整備
- 各フェーズでのドキュメント更新
- API仕様書の整備
- ユーザーマニュアルの作成

## リスク管理

### 技術的リスク
- **WebSocket通信の安定性**: 接続断時の自動再接続機能
- **プロセス管理の複雑性**: 適切なエラーハンドリング
- **セキュリティ**: JWT実装の安全性確保

### スケジュールリスク
- **機能の過大評価**: 各フェーズの機能を最小限に絞る
- **外部依存**: 可能な限り標準ライブラリを使用

## 成功指標

### 技術指標
- サーバー起動時間: 30秒以内
- WebSocket接続安定性: 99%以上
- レスポンス時間: 1秒以内

### ユーザビリティ指標
- 直感的な操作: 説明不要で操作可能
- レスポンシブデザイン: スマートフォン対応
- エラー処理: 分かりやすいエラーメッセージ

## 次のステップ

1. **ヘッドレスプロセス管理サービス**: `backend/src/services` に Resonite.exe の起動・停止・状態取得を実装し、ログをリングバッファで保持する。参照ログとして `sample/バニラで起動したときのコンソール画面.txt` を利用する。
2. **API/ソケット基盤**: 起動・停止・ステータス取得API、およびログ配信用Socket.io名前空間を整備する。
3. **フロントエンド最小UI**: サーバー操作とリアルタイムログ表示を行うダッシュボード原型を Skeleton UI で構築する。
4. **設定ファイルテンプレート**: `config/headless` に運用テンプレートを配置し、バックエンドから一覧取得できるようにする。
5. **動作確認・記録**: 起動/停止・ログ配信の動作を確認し、必要な改善点を洗い出す。
