# MarkN Resonite Headless Controller タスク分解

## フェーズ1: 最小構成 (MVP)

### 1.1 プロジェクト基盤構築
**優先度**: 高 | **推定時間**: 2-3日

#### タスク1.1.1: 開発環境セットアップ
- [ ] Node.js開発環境の確認 (v20 LTS 推奨)
- [ ] npmワークスペース構成の初期化 (`package.json`)
- [ ] `.env.example` の作成 (`AUTH_SHARED_SECRET` など基本項目)
- [ ] ルート依存関係のインストール
  - [ ] `eslint`, `prettier`, `typescript`, `dotenv`
- [ ] backend ワークスペース作成 (`backend/package.json`)
- [ ] frontend ワークスペース作成 (`frontend/package.json`)

#### タスク1.1.2: ディレクトリ構造整備
- [ ] ルート構成を作成 (`backend/`, `frontend/`, `shared/`, `config/`, `scripts/` など)
- [ ] `config/headless/` ディレクトリ作成（Resonite 設定格納）
- [ ] `config/security.json` テンプレート作成（許可CIDRを定義）
- [ ] `shared/` に共通型定義用のベースファイルを作成

#### タスク1.1.3: セキュリティ設定準備
- [ ] `AUTH_SHARED_SECRET` を読み込むユーティリティ実装
- [ ] APIキー派生ロジックの雛形 (`sha256(secret + "api")`)
- [ ] セキュリティ関連ドキュメント整備

### 1.2 バックエンド基本機能
**優先度**: 高 | **推定時間**: 3-4日

#### タスク1.2.1: Webサーバー構築
- [ ] Express.js + Socket.io の初期セットアップ (`backend/src/app.ts`)
- [ ] CORS設定とヘッダ調整
- [ ] JWTミドルウェアの骨格実装
- [ ] セキュリティログ出力基盤

#### タスク1.2.2: WebSocket通信実装
- [ ] Socket.ioサーバー設定 (名前空間/Room 構成)
- [ ] JWTバリデーション付き接続ハンドシェイク
- [ ] ログ配信イベントと履歴取得API
- [ ] 接続断・リトライ時のハンドリング

#### タスク1.2.3: プロセス管理機能
- [ ] Resonite.exe の起動・停止制御 (`child_process.spawn`)
- [ ] `config/headless` 内の設定ファイル選択
- [ ] 標準出力/エラーのリングバッファ化 (最新1,000行)
- [ ] WebSocket配信用にログイベントをエンキュー
- [ ] 起動失敗・異常終了時の通知処理

### 1.3 フロントエンド基本機能
**優先度**: 高 | **推定時間**: 3-4日

#### タスク1.3.1: Skeleton UIセットアップ
- [ ] SvelteKit プロジェクト初期化
- [ ] Tailwind + Skeleton UI インストールと設定
- [ ] Resonite公式カラーを Tailwind テーマに追加
- [ ] 全体レイアウトとナビゲーションの骨組み

#### タスク1.3.2: WebSocket通信実装
- [ ] Socket.io クライアント設定
- [ ] JWT付与付き接続ロジック
- [ ] リアルタイムログ表示コンポーネント（リングバッファと連携）
- [ ] 接続ステータス/再接続UI

#### タスク1.3.3: サーバー操作UI
- [ ] 起動/停止/再起動ボタン
- [ ] 現在の設定ファイル選択ドロップダウン
- [ ] ステータスインジケーターとエラー表示
- [ ] アクセスログ/操作ログ表示

### 1.4 ログ表示機能
**優先度**: 中 | **推定時間**: 2-3日

#### タスク1.4.1: ログ取得機能
- [ ] サーバープロセスの標準出力読み取り
- [ ] ログデータの整形
- [ ] ログレベルの識別
- [ ] ログ履歴の保存

#### タスク1.4.2: ログ表示UI
- [ ] リアルタイムログ表示
- [ ] ログの自動スクロール
- [ ] ログクリア機能
- [ ] 基本的なフィルタリング

## フェーズ2: 基本機能

### 2.1 認証システム
**優先度**: 高 | **推定時間**: 4-5日

#### タスク2.1.1: JWT認証実装
- [ ] `AUTH_SHARED_SECRET` を利用したサイン実装
- [ ] ログインエンドポイント (`/api/auth/login`)
- [ ] トークン検証ミドルウェア (`verifyJwt`)
- [ ] リフレッシュポリシー（短期トークン + 自動再ログイン）

#### タスク2.1.2: 認証UI
- [ ] Skeleton UI のフォームコンポーネントでログイン画面作成
- [ ] 認証状態ストアの実装 (Svelte stores)
- [ ] 認証済みルートのガード
- [ ] ログアウトとトークン破棄処理

#### タスク2.1.3: 認証ミドルウェア
- [ ] REST API の JWT 保護
- [ ] Socket.io 接続時のトークン検証
- [ ] 共通エラー応答フォーマット整備
- [ ] 認証ログ記録

### 2.2 設定管理機能
**優先度**: 高 | **推定時間**: 3-4日

#### タスク2.2.1: 設定ファイル管理
- [ ] `config/headless/` の設定ファイル一覧取得
- [ ] JSONスキーマバリデーション (公式スキーマを活用)
- [ ] 設定の読み込み/保存/バックアップ処理
- [ ] 世界ごとの設定テンプレート生成

#### タスク2.2.2: 設定編集UI
- [ ] 設定ファイル選択ドロップダウンと概要表示
- [ ] JSONエディタ/フォームのハイブリッドUI
- [ ] 保存・プレビュー・検証結果の表示
- [ ] 新規設定ファイルの作成フロー

### 2.3 サーバー状態監視
**優先度**: 中 | **推定時間**: 3-4日

#### タスク2.3.1: システム監視
- [ ] `systeminformation` 等を用いたCPU/メモリ取得
- [ ] リソース情報の定期ポーリングとAPI提供
- [ ] メトリクスキャッシュと警告閾値設定
- [ ] 監視対象項目の設定ファイル化

#### タスク2.3.2: 監視UI
- [ ] リソース使用率表示
- [ ] グラフ表示機能
- [ ] アラート機能
- [ ] 監視設定

### 2.4 セッション管理
**優先度**: 中 | **推定時間**: 2-3日

#### タスク2.4.1: セッション情報取得
- [ ] `/worlds`コマンド実行
- [ ] セッション情報の解析
- [ ] セッション状態の管理
- [ ] セッション切り替え機能

#### タスク2.4.2: セッションUI
- [ ] セッション一覧表示
- [ ] セッション選択機能
- [ ] セッション情報表示
- [ ] セッション操作ボタン

## フェーズ3: 応用機能

### 3.1 ユーザー管理機能
**優先度**: 高 | **推定時間**: 4-5日

#### タスク3.1.1: ユーザー情報取得
- [ ] `/users`コマンド実行
- [ ] ユーザー情報の解析
- [ ] ユーザー状態の管理
- [ ] ユーザー操作の実装

#### タスク3.1.2: ユーザー操作UI
- [ ] ユーザー一覧表示
- [ ] ユーザー操作ボタン
  - [ ] ミュート/ミュート解除
  - [ ] キック
  - [ ] BAN/UNBAN
  - [ ] リスポーン
- [ ] 権限設定機能
- [ ] ユーザー検索機能

### 3.2 ワールド管理機能
**優先度**: 高 | **推定時間**: 3-4日

#### タスク3.2.1: ワールド操作
- [ ] `/save`コマンド実装
- [ ] `/close`コマンド実装
- [ ] `/restart`コマンド実装
- [ ] ワールド状態監視

#### タスク3.2.2: ワールド操作UI
- [ ] ワールド保存ボタン
- [ ] ワールド閉じるボタン
- [ ] ワールド再起動ボタン
- [ ] ワールド状態表示

### 3.3 フレンド管理機能
**優先度**: 中 | **推定時間**: 4-5日

#### タスク3.3.1: フレンド操作
- [ ] `/friendRequests`コマンド実装
- [ ] `/acceptFriendRequest`コマンド実装
- [ ] `/sendFriendRequest`コマンド実装
- [ ] `/removeFriend`コマンド実装
- [ ] `/listbans` と BAN解除処理

#### タスク3.3.2: フレンド管理UI
- [ ] フレンドリクエスト一覧
- [ ] フレンドリクエスト承認/拒否
- [ ] フレンドリクエスト送信
- [ ] フレンド解除機能

### 3.4 チャット機能
**優先度**: 中 | **推定時間**: 2-3日

#### タスク3.4.1: チャット送信
- [ ] `/message`コマンド実装
- [ ] チャット履歴管理
- [ ] チャット送信UI
- [ ] エラーハンドリング

## フェーズ4: 外部連携

### 4.1 REST API実装
**優先度**: 高 | **推定時間**: 4-5日

#### タスク4.1.1: API設計
- [ ] API仕様書作成
- [ ] エンドポイント設計
- [ ] リクエスト/レスポンス形式定義
- [ ] 認証方式決定

#### タスク4.1.2: API実装
- [ ] セッション管理API
- [ ] ユーザー管理API
- [ ] ワールド操作API
- [ ] フレンド管理API

### 4.2 外部連携機能
**優先度**: 中 | **推定時間**: 3-4日

#### タスク4.2.1: Resonite Mod連携
- [ ] Mod連携API実装
- [ ] イベント通知機能
- [ ] データ同期機能
- [ ] エラーハンドリング

### 4.3 UI/UX改善
**優先度**: 中 | **推定時間**: 3-4日

#### タスク4.3.1: デザイン改善
- [ ] モダンなUIデザイン
- [ ] アニメーション効果
- [ ] レスポンシブデザイン改善
- [ ] アクセシビリティ対応

#### タスク4.3.2: パフォーマンス最適化
- [ ] コード分割
- [ ] 遅延読み込み
- [ ] キャッシュ最適化
- [ ] バンドルサイズ最適化

## 共通タスク

### テスト実装
**優先度**: 高 | **推定時間**: 各フェーズで2-3日

#### 単体テスト
- [ ] バックエンドAPIテスト
- [ ] フロントエンドコンポーネントテスト
- [ ] ユーティリティ関数テスト
- [ ] 統合テスト

#### テスト自動化
- [ ] CI/CDパイプライン構築
- [ ] 自動テスト実行
- [ ] テストカバレッジ測定
- [ ] テストレポート生成

### ドキュメント整備
**優先度**: 中 | **推定時間**: 各フェーズで1-2日

#### 技術ドキュメント
- [ ] API仕様書
- [ ] アーキテクチャドキュメント
- [ ] セットアップガイド
- [ ] トラブルシューティングガイド

#### ユーザードキュメント
- [ ] ユーザーマニュアル
- [ ] 機能説明書
- [ ] FAQ
- [ ] チュートリアル

## タスク管理

### 進捗追跡
- [ ] 各タスクの完了状況
- [ ] 予定時間と実際の時間
- [ ] ブロッカーの特定
- [ ] リスクの早期発見

### 品質管理
- [ ] コードレビュー
- [ ] テスト実行
- [ ] パフォーマンス測定
- [ ] セキュリティチェック

### 継続的改善
- [ ] フィードバック収集
- [ ] 問題点の分析
- [ ] 改善案の検討
- [ ] プロセス最適化

---

## 追加タスク: ワールド検索して起動

1. バックエンドAPIの追加（/api/world-search）
   - [ ] 依存追加: cheerio
   - [ ] ルート追加: `backend/src/http/routes/serverRoutes.ts`
   - [ ] スクレイピング実装: `https://go.resonite.com/world?term=<term>`
   - [ ] 解析: タイトル/相対URL/画像URL → recordId/resoniteUrl 生成
   - [ ] 入力バリデーション・タイムアウト・エラーハンドリング
   - [ ] 短期TTLキャッシュ（任意）

2. フロントAPI関数の追加
   - [ ] `frontend/src/lib/api.ts` に `getWorldSearch(term)` を追加
   - [ ] エラー時の例外化・型定義

3. UI実装（newWorld 右カラム）
   - [ ] 検索入力と検索ボタン（status-form/field-row 準拠）
   - [ ] ローディング・エラー表示
   - [ ] 結果カードグリッド（画像・タイトル・選択状態）
   - [ ] 「このワールドを起動」ボタン（選択時のみ活性）

4. コマンド送信
   - [ ] `postCommand('startworldurl <resoniteUrl>')` 呼び出し

5. テスト
   - [ ] 代表クエリでの結果確認
   - [ ] 画像なしフォールバック
   - [ ] 起動ボタン動作確認（トースト）

6. 将来拡張（任意）
   - [ ] ページング/無限スクロール
   - [ ] 最近検索/最近起動
   - [ ] 並べ替え（関連度/新着）