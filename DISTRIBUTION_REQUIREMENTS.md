# MarkNResoniteHeadlessController 配布・アップデート・実行要件定義書

## 概要

MarkNResoniteHeadlessControllerは、ResoniteヘッドレスサーバーをブラウザUIから管理するためのツールです。本ドキュメントでは、配布、アップデート、実行に関する要件を定義します。

## 配布方式

### 1. 配布形式

- **Zipアーカイブ**: Windows環境向けに必要なファイルとスクリプトをまとめたZipパッケージ
- **起動スクリプト**: `scripts/start-production.bat` を利用してNode.jsプロセスとして起動
- **設定ファイル**: 初回実行時に自動生成されるデフォルト設定ファイルと、同梱するサンプル設定

### 2. 配布パッケージ構成

```
MarkNResoniteHeadlessController/
├── backend/
│   └── dist/backend/src/...             # コンパイル済みNode.jsアプリ
├── frontend/
│   └── build/...                        # 静的フロントエンドファイル
├── shared/
│   └── dist/...                         # 共有ライブラリのビルド成果物
├── scripts/
│   ├── setup.bat                        # 初回セットアップ用スクリプト
│   └── start-production.bat             # 起動スクリプト
├── config/
│   ├── *.json.example                   # サンプル設定ファイル
│   └── headless/                        # Resoniteヘッドレス向け補助ファイル（任意）
├── package.json                         # ルートパッケージ設定
├── package-lock.json                    # 依存関係ロックファイル
├── README.md                            # 使用方法
└── その他必要なドキュメント/スクリプト
```

### 3. パッケージ作成プロセス

#### 3.1 開発者向け準備コマンド

```bash
# 依存関係のインストール
npm install

# 共有ライブラリ・バックエンド・フロントエンドのビルド
npm run build --workspace=shared
npm run build --workspace=backend
npm run build --workspace=frontend
```

#### 3.2 パッケージング手順

1. `backend/dist`・`shared/dist`・`frontend/build` が最新のビルド結果であることを確認
2. `config/*.example` や `config/headless` など、配布時に同梱したいファイルを整理
3. `scripts/start-production.bat` と `scripts/setup.bat` を含めてWindowsユーザーが起動しやすい構成にする
4. `node_modules` や一時ファイルは含めず、ルートディレクトリをZip圧縮して配布用アーカイブを作成
5. 配布アーカイブに README / ドキュメントを同梱し、初回セットアップ手順を明記

#### 3.3 Zipパッケージの自動生成

Windows環境では `npm run package:zip` または `scripts\package-distribution.bat` を使用すると、上記手順を自動化して `dist/MarkNResoniteHeadlessController.zip` を生成できます。
- デフォルトで `npm run build` を実行したうえでステージング → Zip 化 → クリーンアップを行います
- `scripts/package-distribution.ps1 -SkipBuild` を使えばビルド済み成果物をそのまま打包できます
- `.env` や `config/*.json` など機密情報は自動的に除外されます（`.example` と `sample` のみ同梱）

## 設定ファイルの自動生成

### 1. 自動生成される設定ファイル

| ファイル名 | 説明 | デフォルト値 |
|-----------|------|-------------|
| `auth.json` | 認証設定 | JWT秘密鍵、デフォルトパスワード |
| `security.json` | セキュリティ設定 | 許可IP範囲（ローカルネットワーク） |
| `runtime-state.json` | ランタイム状態 | 初期状態（停止中） |
| `restart.json` | 再起動設定 | デフォルト再起動設定 |
| `restart-status.json` | 再起動ステータス | 初期ステータス |

### 2. 自動生成のタイミング

- **初回実行時**: 設定ファイルが存在しない場合に自動生成
- **エラー時**: 設定ファイルの読み込みに失敗した場合にデフォルト設定で再生成
- **アップデート時**: 既存の設定ファイルは保持され、新しい設定項目のみ追加

### 3. 設定ファイルの保護

- 配布パッケージには設定ファイルを含めない
- ユーザーの設定は上書きされない
- アップデート時も既存設定を保持

## アップデート方式

### 1. アップデートの種類

#### 1.1 手動アップデート
- 新しいZipアーカイブをダウンロード
- 稼働中のアプリケーションを停止
- 既存ディレクトリに上書き展開するか、新しい場所へ展開して設定ファイルのみコピー

#### 1.2 自動アップデート（将来実装予定）
- アプリケーション内でのアップデート通知
- ワンクリックでのアップデート実行
- 設定ファイルの自動バックアップ

### 2. アップデート時の注意事項

- **設定ファイルの保持**: 既存の設定ファイルは上書きされない
- **データの保持**: ランタイム状態やログは保持される
- **互換性**: 新しいバージョンは既存の設定ファイルと互換性を保つ

### 3. アップデート手順

1. 現在のアプリケーションを停止
2. 新しいZipアーカイブを取得
3. 配布物を展開し、`config/` や `.env` などユーザー固有ファイルを除いて上書き
4. 必要に応じて依存関係を再インストール（`npm install --omit=dev` など）
5. `scripts/start-production.bat` で再起動し、設定を確認

## 実行方式

### 1. 初回実行

1. 配布Zipを任意の場所に展開
2. `scripts/setup.bat` を実行して依存関係のインストールと設定ファイル生成を行う
3. `scripts/start-production.bat` を実行してバックエンドサービスを起動
4. ブラウザで `http://localhost:8080` にアクセス
5. デフォルトパスワード（`admin123`）でログインし、必要に応じて設定を更新

### 2. 通常実行

1. `scripts/start-production.bat` を実行
2. ブラウザで `http://localhost:8080` にアクセス
3. 設定したパスワードでログイン

### 3. 実行環境要件

- **OS**: Windows 10/11 (64bit)
- **ランタイム**: Node.js 20.x 以上（配布物には含まれないため各自でインストール）
- **メモリ**: 最低512MB、推奨1GB以上
- **ディスク**: 最低100MBの空き容量
- **ネットワーク**: ローカルネットワークアクセス（オプション）

### 4. ポート設定

- **デフォルトポート**: 8080
- **変更可能**: 環境変数`PORT`で変更可能
- **ファイアウォール**: 必要に応じてポート8080を開放

## セキュリティ考慮事項

### 1. 認証

- **デフォルトパスワード**: 初回実行時は`admin123`
- **パスワード変更**: Web UIから変更可能
- **JWT認証**: セッション管理にJWTを使用

### 2. ネットワークセキュリティ

- **デフォルトアクセス**: ローカルホストのみ
- **IP制限**: `security.json`で許可IP範囲を設定
- **HTTPS**: 本番環境ではHTTPSの使用を推奨

### 3. 設定ファイルの保護

- **権限設定**: 設定ファイルは適切な権限で保護
- **バックアップ**: 重要な設定は定期的にバックアップ
- **暗号化**: 機密情報は必要に応じて暗号化

## トラブルシューティング

### 1. よくある問題

#### 1.1 アプリケーションが起動しない
- **原因**: ポート8080が使用中
- **解決**: 他のアプリケーションを終了するか、環境変数`PORT`でポートを変更

#### 1.2 設定ファイルが読み込めない
- **原因**: 設定ファイルの破損
- **解決**: 該当する設定ファイルを削除して再起動（自動再生成される）

#### 1.3 Web UIにアクセスできない
- **原因**: ファイアウォールの設定
- **解決**: ポート8080をファイアウォールで許可

### 2. ログの確認

- **コンソールログ**: `scripts/start-production.bat` 実行時のコンソール出力
- **アプリケーションログ**: Web UI内のログ表示機能
- **システムログ**: Windowsイベントログ

### 3. サポート

- **ドキュメント**: README.md、DEPLOYMENT.md
- **設定例**: `config/`ディレクトリのサンプルファイル
- **コミュニティ**: GitHub Issues、Discord等

## 今後の改善予定

### 1. 短期改善

- [ ] 自動アップデート機能の実装
- [ ] 設定ファイルのバックアップ機能
- [ ] より詳細なログ機能

### 2. 中期改善

- [ ] マルチプラットフォーム対応（Linux、macOS）
- [ ] クラスター対応
- [ ] 監視・アラート機能

### 3. 長期改善

- [ ] クラウド連携
- [ ] モバイルアプリ
- [ ] 高度な分析機能

## まとめ

MarkNResoniteHeadlessControllerは、シンプルで使いやすい配布方式を採用しています。設定ファイルの自動生成により、ユーザーは複雑な設定を行うことなく、すぐにアプリケーションを使用開始できます。アップデート時も既存の設定が保持されるため、継続的な使用が可能です。

配布、アップデート、実行の各段階で、ユーザビリティとセキュリティを両立した設計となっています。